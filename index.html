<script>
  const STORAGE_KEY = "so_t_leaders_v1";

  function getDefaultLeaders() {
    return [
      {
        name: "김현수",
        role: "베트남 장기 체류 리더 · 10년 차 가이드",
        mediaType: "image",
        mediaUrl: "https://via.placeholder.com/300x380.png?text=Leader+1",
        link: "#",
        tags: ["장기 체류", "로컬 생활", "루틴 여행"],
        introShort: "여행이 아니라 ‘살아보는 시간’을 설계합니다. 최소 1개월 이상 머무는 루트를 함께 짭니다."
      }
    ];
  }

  function loadLeaders() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return getDefaultLeaders();
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || parsed.length === 0) return getDefaultLeaders();
      return parsed;
    } catch {
      return getDefaultLeaders();
    }
  }

  let leaders = loadLeaders();

  function saveLeaders() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(leaders));
    renderLeaderList();
    alert("저장되었습니다. 공개 페이지(index.html)를 새로고침하면 반영됩니다.");
  }

  const leaderListEl = document.getElementById("leaderList");
  const editingIndexEl = document.getElementById("editingIndex");

  function renderLeaderList() {
    leaderListEl.innerHTML = "";
    if (leaders.length === 0) {
      leaderListEl.innerHTML = "<p style='font-size:12px;color:#6b7280;'>등록된 리더가 없습니다.</p>";
      return;
    }
    leaders.forEach((leader, index) => {
      const item = document.createElement("div");
      item.className = "leader-item";
      item.innerHTML = `
        <div class="leader-item-header">
          <div style="display:flex;align-items:center;">
            ${leader.mediaUrl ? `<img src="${leader.mediaUrl}" class="thumb" alt="">` : ""}
            <div>
              <div class="leader-item-name">${leader.name || "(이름 없음)"}</div>
              <div style="font-size:11px;color:#6b7280;">${leader.role || ""}</div>
              <div style="font-size:10px;color:#9ca3af;max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                ${leader.link || ""}
              </div>
            </div>
          </div>
          <div>
            <button class="btn btn-secondary" onclick="editLeader(${index})">수정</button>
            <button class="btn btn-danger" onclick="deleteLeader(${index})">삭제</button>
          </div>
        </div>
        <div style="font-size:11px;color:#4b5563;">
          태그: ${(leader.tags || []).join(", ") || "-"}
        </div>
      `;
      leaderListEl.appendChild(item);
    });
  }

  const nameInput  = document.getElementById("leaderName");
  const roleInput  = document.getElementById("leaderRole");
  const linkInput  = document.getElementById("leaderLink");
  const tagsInput  = document.getElementById("leaderTags");
  const introInput = document.getElementById("leaderIntro");
  const mediaInput = document.getElementById("leaderMediaFile");
  const dropZone   = document.getElementById("dropZone");
  const imagePreviewWrap = document.getElementById("imagePreviewWrap");
  const imagePreview     = document.getElementById("imagePreview");
  const videoPreview     = document.getElementById("videoPreview");

  let tempMediaDataUrl = "";
  let tempMediaType    = "image";

  function clearPreview() {
    imagePreviewWrap.style.display = "none";
    imagePreview.style.display = "none";
    videoPreview.style.display = "none";
    imagePreview.src = "";
    videoPreview.src = "";
  }

  function showPreview(type, dataUrl) {
    tempMediaType = type;
    tempMediaDataUrl = dataUrl;
    imagePreviewWrap.style.display = "block";
    if (type === "video") {
      imagePreview.style.display = "none";
      videoPreview.style.display = "block";
      videoPreview.src = dataUrl;
      videoPreview.play();
    } else {
      videoPreview.pause();
      videoPreview.style.display = "none";
      imagePreview.style.display = "block";
      imagePreview.src = dataUrl;
    }
  }

  function handleFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const dataUrl = e.target.result;
      if (file.type.startsWith("video/")) {
        showPreview("video", dataUrl);
      } else {
        showPreview("image", dataUrl);
      }
    };
    reader.readAsDataURL(file);
  }

  mediaInput.addEventListener("change", function () {
    const file = this.files[0];
    handleFile(file);
  });

  ["dragenter","dragover"].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add("dragover");
    });
  });
  ["dragleave","drop"].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove("dragover");
    });
  });
  dropZone.addEventListener("drop", e => {
    const file = e.dataTransfer.files[0];
    handleFile(file);
  });

  function clearForm() {
    editingIndexEl.value = -1;
    nameInput.value = "";
    roleInput.value = "";
    linkInput.value = "";
    tagsInput.value = "";
    introInput.value = "";
    mediaInput.value = "";
    tempMediaDataUrl = "";
    tempMediaType = "image";
    clearPreview();
  }

  document.getElementById("clearFormBtn").addEventListener("click", clearForm);

  document.getElementById("saveLeaderBtn").addEventListener("click", function () {
    const name = nameInput.value.trim();
    if (!name) {
      alert("이름은 필수입니다.");
      return;
    }
    const role = roleInput.value.trim();
    const link = linkInput.value.trim();
    const tags = tagsInput.value.split(",").map(t => t.trim()).filter(Boolean);
    const introShort = introInput.value.trim();
    const index = parseInt(editingIndexEl.value, 10);

    const baseData = { name, role, link, tags, introShort };

    if (index >= 0) {
      const prev = leaders[index];
      leaders[index] = {
        ...prev,
        ...baseData,
        mediaType: tempMediaDataUrl ? tempMediaType : (prev.mediaType || "image"),
        mediaUrl: tempMediaDataUrl || prev.mediaUrl || ""
      };
    } else {
      leaders.push({
        ...baseData,
        mediaType: tempMediaDataUrl ? tempMediaType : "image",
        mediaUrl: tempMediaDataUrl || ""
      };
    }

    saveLeaders();
    clearForm();
  });

  window.editLeader = function (index) {
    const leader = leaders[index];
    editingIndexEl.value = index;
    nameInput.value  = leader.name || "";
    roleInput.value  = leader.role || "";
    linkInput.value  = leader.link || "";
    tagsInput.value  = (leader.tags || []).join(", ");
    introInput.value = leader.introShort || "";

    tempMediaDataUrl = leader.mediaUrl || "";
    tempMediaType    = leader.mediaType || "image";

    if (tempMediaDataUrl) {
      showPreview(tempMediaType, tempMediaDataUrl);
    } else {
      clearPreview();
    }
    mediaInput.value = "";
  };

  window.deleteLeader = function (index) {
    if (!confirm("이 리더를 삭제할까요?")) return;
    leaders.splice(index, 1);
    saveLeaders();
    clearForm();
  };

  renderLeaderList();
</script>
